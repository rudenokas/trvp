<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>✈️ Авиакомпания - Управление рейсами</title>

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">

    <style>
        body {
            background-color: #f8f9fa;
            padding-bottom: 50px;
        }

        .container {
            background-color: white;
            border-radius: 10px;
            padding: 30px;
            margin-top: 20px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .nav-tabs .nav-link {
            font-weight: 500;
        }

        .nav-tabs .nav-link.active {
            background-color: #f8f9fa;
            border-bottom-color: #f8f9fa;
        }

        .flight-card {
            transition: transform 0.2s;
            height: 100%;
        }

        .flight-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .filter-section {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .message-alert {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .floating-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body>
    <!-- Сообщения -->
    <div id="message" class="message-alert alert alert-dismissible fade show d-none">
        <button type="button" class="btn-close" onclick="this.parentElement.classList.add('d-none')"></button>
        <span id="messageText"></span>
    </div>

    <!-- Загрузка -->
    <div id="loading" class="position-fixed top-0 start-0 w-100 h-100 bg-dark bg-opacity-50 d-none" style="z-index: 9998;">
        <div class="d-flex justify-content-center align-items-center h-100">
            <div class="text-center">
                <div class="spinner-border text-primary" style="width: 4rem; height: 4rem;" role="status">
                    <span class="visually-hidden">Загрузка...</span>
                </div>
                <p class="text-white mt-3" id="loadingText">Загрузка...</p>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Заголовок -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="mb-2">
                    <i class="bi bi-airplane-fill text-primary me-2"></i>
                    Авиакомпания - Управление рейсами
                </h1>
                <p class="text-muted mb-0">
                    <span id="statsInfo">Загрузка...</span>
                </p>
            </div>
            <button class="btn btn-outline-primary" onclick="refreshData()">
                <i class="bi bi-arrow-clockwise"></i> Обновить
            </button>
        </div>

        <!-- Вкладки -->
        <ul class="nav nav-tabs mb-4">
            <li class="nav-item">
                <a class="nav-link active" data-tab="flights" href="#">
                    <i class="bi bi-airplane me-1"></i> Рейсы
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" data-tab="airplanes" href="#">
                    <i class="bi bi-gear me-1"></i> Самолеты
                </a>
            </li>
        </ul>

        <!-- Рейсы -->
        <div id="flightsContent">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0">
                    <i class="bi bi-list-ul me-2"></i>Список рейсов
                </h3>
                <button class="btn btn-primary" onclick="showFlightModal()">
                    <i class="bi bi-plus-circle me-1"></i> Добавить рейс
                </button>
            </div>

            <!-- Фильтры -->
            <div class="filter-section">
                <div class="row g-3">
                    <div class="col-md-6">
                        <input type="text" id="searchInput" class="form-control" placeholder="Поиск по направлению...">
                    </div>
                    <div class="col-md-3">
                        <select id="airplaneFilter" class="form-control">
                            <option value="">Все самолеты</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="availabilityFilter" class="form-control">
                            <option value="">Все рейсы</option>
                            <option value="available">Есть места</option>
                            <option value="full">Заполнены</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Список рейсов -->
            <div id="flightsContainer">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Загрузка...</span>
                    </div>
                    <p class="mt-2">Загрузка рейсов...</p>
                </div>
            </div>
        </div>

        <!-- Самолеты -->
        <div id="airplanesContent" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0">
                    <i class="bi bi-gear me-2"></i>Самолеты
                </h3>
                <button class="btn btn-success" onclick="refreshAirplanes()">
                    <i class="bi bi-arrow-clockwise me-1"></i> Обновить
                </button>
            </div>

            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Наименование</th>
                            <th>Вместимость</th>
                            <th>Статус</th>
                        </tr>
                    </thead>
                    <tbody id="airplanesTable">
                        <tr>
                            <td colspan="4" class="text-center">Загрузка...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Футер -->
        <div class="mt-5 pt-4 border-top text-center text-muted">
            <p class="mb-1">
                <i class="bi bi-c-circle"></i> Авиакомпания - Система управления рейсами
            </p>
            <p class="mb-0">
                <small>Всего рейсов: <span id="totalFlights">0</span> | Самолеты: <span id="totalAirplanes">0</span></small>
            </p>
        </div>
    </div>

    <!-- Модальное окно рейса -->
    <div class="modal fade" id="flightModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Добавить рейс</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="flightForm">
                        <input type="hidden" id="flightId">
                        <div class="mb-3">
                            <label class="form-label">Дата и время вылета *</label>
                            <input type="datetime-local" class="form-control" id="departureDatetime" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Пункт назначения *</label>
                            <input type="text" class="form-control" id="destination" required placeholder="Москва, Париж...">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Самолет *</label>
                            <select class="form-control" id="airplaneSelect" required>
                                <option value="">Выберите самолет...</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="saveFlight()">Сохранить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно броней -->
    <div class="modal fade" id="bookingsModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Брони рейса</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6>Рейс: <span id="currentFlightInfo" class="text-primary">-</span></h6>
                        <small class="text-muted">ID: <span id="flightIdDisplay">-</span></small>
                        <button class="btn btn-success btn-sm float-end" onclick="showAddBookingModal()">
                            <i class="bi bi-plus-circle"></i> Добавить бронь
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>ID брони</th>
                                    <th>Пассажир</th>
                                    <th class="text-end">Действия</th>
                                </tr>
                            </thead>
                            <tbody id="bookingsTable">
                                <tr>
                                    <td colspan="3" class="text-center">Загрузка...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Секция переноса -->
                    <div class="card mt-4" id="transferSection" style="display: none;">
                        <div class="card-header bg-warning">
                            <i class="bi bi-arrow-right-circle"></i> Перенос брони
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <strong>Пассажир:</strong> <span id="transferPassenger" class="badge bg-info">-</span>
                                <small class="text-muted ms-2" id="transferBookingIdDebug"></small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Новый рейс:</label>
                                <select class="form-control" id="transferFlightSelect">
                                    <option value="">Загрузка...</option>
                                </select>
                            </div>
                            <div class="d-flex justify-content-end gap-2">
                                <button class="btn btn-secondary" onclick="cancelTransfer()">Отмена</button>
                                <button class="btn btn-warning" onclick="transferBooking()" id="transferButton" disabled>
                                    <i class="bi bi-arrow-right"></i> Перенести
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления брони -->
    <div class="modal fade" id="addBookingModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Добавить бронь</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="bookingForm">
                        <input type="hidden" id="currentFlightIdForBooking">
                        <div class="mb-3">
                            <label class="form-label">ФИО пассажира *</label>
                            <input type="text" class="form-control" id="passengerName" required placeholder="Иванов Иван Иванович">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" onclick="addBooking()">Добавить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Кнопка добавления -->
    <button class="floating-btn btn-primary" onclick="showFlightModal()" title="Добавить рейс">
        <i class="bi bi-plus-lg"></i>
    </button>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Наш JS -->
    <script src="{{ url_for('static', filename='js/app.js') }}"></script>

    <script>
        // Обновление статистики
        async function updateStats() {
            try {
                const response = await fetch('/api/status');
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'ok') {
                        document.getElementById('totalFlights').textContent = data.stats.flights_count;
                        document.getElementById('totalAirplanes').textContent = data.stats.airplanes_count;
                        document.getElementById('statsInfo').textContent =
                            `Рейсы: ${data.stats.flights_count} | Самолеты: ${data.stats.airplanes_count} | Брони: ${data.stats.bookings_count}`;
                    }
                }
            } catch (error) {
                console.error('Ошибка статистики:', error);
            }
        }

        // Обновляем статистику при загрузке и периодически
        document.addEventListener('DOMContentLoaded', updateStats);
        setInterval(updateStats, 30000);
    </script>
</body>
</html>